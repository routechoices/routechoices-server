{% extends "dashboard/home.html" %}
{% load static %}
{% load bootstrap3 %}
{% load hosts %}
{%  block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="{% static '/vendor/selectize-0.13.3/selectize.bootstrap3.css' %}" />
{%  endblock %}

{% block sub_content %}
<div class="row">
    <div class="col-xs-12">
        <h1>{% if context == 'edit' %}Edit Club{% else %}New CLub{% endif %}</h1>
        <form action="" method="post">
            {% csrf_token %}
            {% bootstrap_form form %}
            <input type="submit" value="Submit" class="btn btn-primary">
            {% if context == 'edit' and not club.active_subscription_id %}<a href="{% url 'dashboard:club_delete_view' id=club.aid %}" class="btn btn-danger">Delete</a>{% endif %}
        </form>
    </div>
    {% if context == 'edit' %}
    <div class="col-xs-12">
        {% if not club.active_subscription_id %}
        <h2>Buy a plan for this club</h2>
        <p>Each plan comes with a 15 days trial period.</p>
        <p>You can cancel your plan any time.</p>
        <p>A plan allows you to create and edit as many events as you desire.</p>
        <div style="margin-bottom: 15px">
        <form id="payment-form">
            <div style="margin-bottom: 15px">
            <h4>Card details</h4>
            <div id="card-element">
              <!-- Elements will create input elements here -->
            </div>
            <h4>Email address for billing</h4>
            <input class="form-control" type="email" required id="id_billing_email"/>
            <!-- We'll put the error messages in this element -->
            </div>
            <div id="card-element-errors" role="alert" class="hidden alert alert-danger"></div>
            <button class="btn btn-primary" type="submit" value="{{monthly_plan_id}}">Buy monthly plan (20€/month)</button>&nbsp;
            <button class="btn btn-success" type="submit" value="{{yearly_plan_id}}">Buy annual plan (200€/year)</button>
          </form>
          </div>
          <div id="messages" class="hidden alert alert-info"></div>
          <div id="errors" class="hidden alert alert-danger"></div>
        {% else %}
        <h2>You have an active plan</h2>
        <div style="margin-bottom: 15px;">
          <button id="cancel-btn" class="btn btn-danger">Cancel plan</button>
        </div>
        <div id="messages" class="hidden alert alert-info"></div>
        <div id="errors" class="hidden alert alert-danger"></div>
        <p>If you cancel your plan, you will not be able to create or edit any events for this club anymore.</p>
        <p>Events previously created will remain as they were and will not be deleted.</p>
        
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_body %}
{{ block.super }}
<script src="https://js.stripe.com/v3/"></script>
<script src="{% static '/vendor/selectize-0.13.3/selectize.min.js' %}"></script>
<script>
$('#id_admins').selectize({
    valueField: 'id',
    labelField: 'username',
    searchField: 'username',
    multiple: true,
    create: false,
    load: function(query, callback) {
        if (!query.length || query.length < 2) return callback();
        $.ajax({
            url: '{% host_url 'user_search_api' host 'api' %}?q=' + encodeURIComponent(query),
            type: 'GET',
            error: function() {
                callback();
            },
            success: function(res) {
                callback(res.results);
            }
        });
    }
});
</script>
{% if context == 'edit' %}
<script>
var stripe = Stripe('{{ stripe_publishable_key }}');
document.addEventListener('DOMContentLoaded', () => {
  {% if not club.active_subscription_id %}
  
  var elements = stripe.elements();
  var card = elements.create('card', {hidePostalCode: true, style: {base: {maxWidth: '500px'}}});
  card.mount('#card-element');
  card.on('change', function (event) {
    displayError(event);
  });
  var form = document.getElementById('payment-form');

  form.addEventListener('submit', function (ev) {
    ev.preventDefault();
    console.log(ev);
    createPaymentMethod({card, priceId: ev.submitter.value})
  });
  {% else %}
  var cancelBtn = document.querySelector('#cancel-btn');
  cancelBtn.addEventListener('click', onCancelSubscription)
  {% endif %}
})

function setMessage(message){
    var messagesDiv = document.querySelector('#messages');
    messagesDiv.innerHTML = message;
    if (message === '') {
        $('#messages').addClass('hidden')
    } else {
        $('#messages').removeClass('hidden')
    }
}

function setError(message){
    setMessage('')
    var messagesDiv = document.querySelector('#errors');
    messagesDiv.innerHTML = message;
    if (message === '') {
        $('#errors').addClass('hidden')
    } else {
        $('#errors').removeClass('hidden')
    }
}

function displayError(event) {
    setMessage('')
    var displayError = document.getElementById('card-element-errors');
    if (event.error) {
        displayError.textContent = event.error.message;
        $('#card-element-errors').removeClass('hidden')
    } else {
        $('#card-element-errors').addClass('hidden')
        displayError.textContent = '';
    }
  }

function onCancelSubscription(ev) {
  ev.preventDefault()
  setMessage("Cancelling subscription...");
  displayError('')
  setError('')
  fetch('/stripe/cancel_subscription/', {
    method: 'POST',
    credentials: 'omit',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      subscriptionId: '{{club.active_subscription_id}}'
    }),
  })
  .then((response) => response.json()).then(() => {
      window.location.reload()
  }).catch(function(e) {
    setError('Something went wrong...')
  })

}

function createPaymentMethod({ card, priceId }) {
  var customerId = '{{ club.get_or_create_stripe_customer_id.0 }}';
  stripe
    .createPaymentMethod({
      type: 'card',
      card: card,
    })
    .then((result) => {
      if (result.error) {
        displayError(result);
      } else {
        createSubscription({
          customerId: customerId,
          paymentMethodId: result.paymentMethod.id,
          priceId: priceId,
        });
      }
    });
}

function createSubscription({ customerId, paymentMethodId, priceId }) {
  setMessage('Creating subscription...')
  displayError('')
  setError('')
  return (
    fetch('/stripe/create_subscription/', {
      method: 'POST',
      credentials: 'omit',
      headers: {
        'Content-type': 'application/json',
      },
      body: JSON.stringify({
        customerId: customerId,
        paymentMethodId: paymentMethodId,
        priceId: priceId,
        billingEmail: $('#id_billing_email').val(),
      }),
    })
      .then((response) => {
        return response.json();
      })
      // If the card is declined, display an error to the user.
      .then((result) => {
        if (result.error) {
          // The card had an error when trying to attach it to a customer.
          throw result;
        }
        return result;
      })
      // Normalize the result to contain the object returned by Stripe.
      // Add the additional details we need.
      .then((result) => {
        return {
          paymentMethodId: paymentMethodId,
          priceId: priceId,
          subscription: result,
        };
      })
      // Some payment methods require a customer to be on session
      // to complete the payment process. Check the status of the
      // payment intent to handle these actions.
      .then(handlePaymentThatRequiresCustomerAction)
      // If attaching this card to a Customer object succeeds,
      // but attempts to charge the customer fail, you
      // get a requires_payment_method error.
      .then(handleRequiresPaymentMethod)
      // No more actions required. Provision your service for the user.
      .then(onSubscriptionComplete)
      .catch((error) => {
        // An error has happened. Display the failure to the user here.
        // We utilize the HTML element we created.
        displayError(error);
      })
  );
}

function onSubscriptionComplete(result) {
  // Payment was successful.
  window.location.reload();
}

function handlePaymentThatRequiresCustomerAction({
  subscription,
  invoice,
  priceId,
  paymentMethodId,
  isRetry,
}) {
  if (subscription && subscription.status === 'active') {
    // Subscription is active, no customer actions required.
    return { subscription, priceId, paymentMethodId };
  }

  // If it's a first payment attempt, the payment intent is on the subscription latest invoice.
  // If it's a retry, the payment intent will be on the invoice itself.
  var paymentIntent = invoice ? invoice.payment_intent : subscription.latest_invoice.payment_intent;

  if (
    paymentIntent.status === 'requires_action' ||
    (isRetry === true && paymentIntent.status === 'requires_payment_method')
  ) {
    return stripe
      .confirmCardPayment(paymentIntent.client_secret, {
        payment_method: paymentMethodId,
      })
      .then((result) => {
        if (result.error) {
          // Start code flow to handle updating the payment details.
          // Display error message in your UI.
          // The card was declined (i.e. insufficient funds, card has expired, etc).
          throw result;
        } else {
          if (result.paymentIntent.status === 'succeeded') {
            // Show a success message to your customer.
            return {
              priceId: priceId,
              subscription: subscription,
              invoice: invoice,
              paymentMethodId: paymentMethodId,
            };
          }
        }
      })
      .catch((error) => {
        throw error;
      });
  } else {
    // No customer action needed.
    return { subscription, priceId, paymentMethodId };
  }
}

function handleRequiresPaymentMethod({
  subscription,
  paymentMethodId,
  priceId,
}) {
  if (subscription.status === 'active') {
    // subscription is active, no customer actions required.
    return { subscription, priceId, paymentMethodId };
  } else if (
    subscription.latest_invoice.payment_intent.status ===
    'requires_payment_method'
  ) {
    // Using localStorage to manage the state of the retry here,
    // feel free to replace with what you prefer.
    // Store the latest invoice ID and status.
    localStorage.setItem('latestInvoiceId', subscription.latest_invoice.id);
    localStorage.setItem(
      'latestInvoicePaymentIntentStatus',
      subscription.latest_invoice.payment_intent.status
    );
    throw { error: { message: 'Your card was declined.' } };
  } else {
    return { subscription, priceId, paymentMethodId };
  }
}
</script>
{% endif %}
{%  endblock %}
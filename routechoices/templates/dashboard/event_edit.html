{% extends "dashboard/club_view.html" %}
{% load static %}
{% load django_bootstrap5 %}
{% load hosts %}
{% load qr_code %}
{% load compress %}
{%  block extra_head %}
{{ block.super }}
{% compress css %}
<link rel="stylesheet" href="{% static '/vendor/tom-select-2.0.1/tom-select.bootstrap5.min.css' %}" />
<link rel="stylesheet" href="{% static '/vendor/tempus-dominus-6-custom-2/css/tempus-dominus.css' %}"/>
<link rel="stylesheet" href="{% static 'styles/dashboard/event_edit.css' %}"/>
{% endcompress %}
{%  endblock %}

{% block sub_sub_content %}
<div class="row">
    <div class="col-12">
        {% if event %}<h1>{{event.name}}</h1>
        {% if event.shortcut %}
        <div style="display: flex; text-align: center">
            <div><p>{% qr_from_text event.shortcut size="t" image_format="png" error_correction="l" %}<br><small><a class="small qrUrlText" style="font-weight: bold" href="{{ event.shortcut }}">{{ event.shortcut_text }}</a></small></p></div>
        </div>
        {% endif%}
        <div>
            <a href="{{ event.get_absolute_url }}" class="btn btn-primary btn-sm" style="margin-bottom: 2px"><i class="fa fa-sign-in"></i> Open</a>
            {% if not event.hidden %}<a href="{{event.club.nice_url}}{{event.slug}}/export" class="btn btn-sm btn-secondary" style="margin-bottom: 3px"><i class="fa fa-save"></i> Export Page</a>{% endif %}
            {% if event.ended and event.map_id %}<a href="http://3drerun.worldofo.com/2d/?server={{ site.domain }}/api/woo&eventid={{event.aid}}&liveid=-" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary " style="margin-bottom: 3px"><i class="fa fa-external-link" aria-hidden="true"></i> 2DRerun</a>{% endif %}
            {% if not event.ended and event.open_registration %} <a href="{{event.club.nice_url}}{{event.slug}}/registration" class="btn btn-secondary btn-sm" style="margin-bottom: 2px"><i class="fa fa-user-plus"></i> Registration Page</a>{% endif %}
            {% if event.started and event.allow_route_upload %} <a href="{{event.club.nice_url}}{{event.slug}}/route-upload" class="btn btn-secondary btn-sm" style="margin-bottom: 2px"><i class="fa fa-upload"></i> Route Upload Page</a>{% endif %}
            {% if event.started and event.allow_live_chat %} <a href="{% url 'dashboard:event_chat_moderation_view' event_id=event.aid %}" class="btn btn-secondary btn-sm" style="margin-bottom: 2px"><i class="fa fa-comments"></i> Chat Moderation</a>{% endif %}
            {% if event.is_live %} <a href="{% url 'dashboard:event_view_live' event_id=event.aid %}" class="btn btn-secondary btn-sm" style="margin-bottom: 2px"><i class="fa fa-bolt"></i> Live with no delay</a>{% endif %}
        </div>
        {% endif%}
        <h1>{% if context == 'edit' %}Edit Event{% else %}New Event{% endif %} <small><span class="utc-offset"></span></small></h1>
        <form action="" method="post">
            {% csrf_token %}
            {% bootstrap_form form %}
            <h4>Extra Maps</h4>
            <div class="form-text">Extra maps can be used for example if the route is split in multiple parts</div>
            {% bootstrap_formset_errors extra_map_formset %}
            <table class="table">
            {{ extra_map_formset.management_form }}
            {% for form in extra_map_formset %}
               {% if forloop.first %}
                    <thead>
                    <tr>
                        {% for field in form.visible_fields %}
                            <th>{{ field.label|capfirst }}</th>
                        {% endfor %}
                    </tr>
                    </thead>
                {% endif %}
                <tr class="extra_map_formset_row">
                    {% for field in form.visible_fields %}
                        <td>
                            {# Include the hidden fields in the form #}
                            {% if forloop.first %}
                                {% bootstrap_form_errors form layout='inline' %}
                                {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                            {% endif %}
                            {% bootstrap_field field show_label=False %}
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
            </table>
            <hr/>
            <h3>Announcement</h3>
            {% bootstrap_form notice_form %}

            <h3>Competitors{% if event.started %} <a href="{% url 'dashboard:event_route_upload_view' event_id=event.aid %}" class="btn btn-primary" id="upload_route_btn">Upload Competitors Routes</a>{% endif %}</h3>
            {% if not use_competitor_formset and context == 'edit' %}
              <p>You have more than 100 competitors <a class ="btn btn-primary" href="{% url 'dashboard:event_competitors_view' event_id=event.aid %}">Manage existing competitors</a></p>
              <h4>Add more competitors</h4>
            {% endif %}
            {% bootstrap_formset_errors formset %}
            <table class="table competitor_table">
            {{ formset.management_form }}
            {% for form in formset %}
               {% bootstrap_form_errors form type='non_fields' %}
               {% if forloop.first %}
                    <thead>
                    <tr>
                        {% for field in form.visible_fields %}
                            <th>{{ field.label|capfirst }}</th>
                        {% endfor %}
                    </tr>
                    </thead>
                {% endif %}
                <tr class="formset_row">
                    {% for field in form.visible_fields %}
                        <td>
                            {# Include the hidden fields in the form #}
                            {% if forloop.first %}
                                {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                            {% endif %}
                            {% bootstrap_field field show_label=False %}
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
            </table>
            <div class="csv-upload">
                <label for="csv_input" class="form-label">Import competitors from CSV</label>
                <input type="file" name="csv_input" id="csv_input" class="form-control" accept="text/csv"/>
                <div class="form-text">
                    Follow the following format for the CSV:<br/>
                    Column A - Full name / displayed in the menu on the left during the event /<br/>
                    Column B - Shortname / displayed next to the marker on the live event /<br/>
                    Column C - UTC Start time for the competitor in the following format (2014-05-31 08:57:00). Make sure this column is formatted as Text.<br/>
                    Column D - The ID of the GPS device
                </div>
            </div>
            <hr/>

            <input type="submit" value="Save" class="btn btn-primary" id="submit-btn" style="margin-bottom: 3px"/>
            <button type="submit" name="save_continue" value="True" class="btn btn-secondary" style="margin-bottom: 3px">Save and Continue Editing</button>
            {% if context == 'edit' %}<a href="{% url 'dashboard:event_delete_view' event_id=event.aid %}" class="btn btn-danger" style="margin-bottom: 3px">Delete</a>{% endif %}
        </form>
    </div>
</div>
{% endblock %}

{%  block extra_body %}
<script src="{% static '/scripts/load-local-variables.js' %}?_=2022072900" data-api-base-url="{% host_url 'api_doc' host 'api' %}" data-event-id="{{event.aid}}"></script>
{% compress js %}
<script src="{% static '/vendor/jquery-3.6.0/jquery.min.js' %}"></script>
<script src="{% static '/vendor/jquery-formset-1.3.2/jquery.formset.js' %}"></script>
<script src="{% static '/vendor/tom-select-2.0.1/tom-select.custom.js' %}"></script>
<script src="{% static '/vendor/popper-2.11.4/popper.min.js' %}"></script>
<script src="{% static '/vendor/tempus-dominus-6-custom-2/js/tempus-dominus.js' %}"></script>
<script src="{% static '/vendor/umbrella-3.3.0/umbrella.min.js' %}"></script>
<script src="{% static '/vendor/papaparse-5.0.0-beta/papaparse.min.js' %}"></script>
<script src="{% static '/vendor/dayjs-1.10.6/dayjs.min.js' %}"></script>
<script src="{% static '/vendor/reqwest-2.0.5/reqwest.min.js' %}"></script>
<script src="{% static '/scripts/dashboard/event_edit.js' %}"></script>
{% endcompress %}
{%  endblock %}

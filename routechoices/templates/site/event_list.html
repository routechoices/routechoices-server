{% extends "base.html" %}
{% load static %}
{% load django_bootstrap5 %}
{% load hosts %}
{% load markdownify %}
{% load index %}
{% load math %}
{% load compress %}
{% load define_action %}

{% block favicon %}{% if club %}<link rel="apple-touch-icon" href="{{club.nice_url}}apple-touch-icon.png{{club.logo_last_mod}}">
<link rel="icon" sizes="32x32" href="{{club.nice_url}}favicon.ico{{club.logo_last_mod}}">
<link rel="manifest" href="{{club.nice_url}}manifest.json{{club.logo_last_mod}}">{% else %}
<link rel="apple-touch-icon" href="{% static 'apple-touch-icon.png' %}?v=2023c">
<link rel="icon" sizes="32x32" href="{% static 'favicon.ico' %}?v=2023c">
<link rel="manifest" href="{% static 'manifest.json' %}?v=2023c">{% endif %}
{% endblock %}

{% block head_title %}GPS Tracking of Events{%if event_set_page%} {{event_set.name}}{% endif %}{% if club %} by {{club.name}} | Powered by {{site.name}}{% else %} on {{site.name}}{% endif %}{% endblock %}
{% block head_description %}List of events{%if event_set_page%} {{event_set.name}}{% endif %}{% if club %} by {{club.name}}{% else %} on {{site.name}}, a free and open source live GPS tracking solution for orienteering events.{% endif %}{% endblock %}

{% block extra_head %}
<link rel="alternate" type="application/rss+xml" title="{% if club %}{{club.name}} {% else %}{% endif%}GPS Tracking Event Feed" href="{% if club %}{{event.club.nice_url}}feed{% else %}{% url 'site:events_feed' %}{% endif%}" />
<meta property="og:title" content="GPS Tracking of Events{% if club %} by {{club.name}} | Powered by {{site.name}}{% else %} on {{site.name}}{% endif %}" />
<meta property="og:description" content="List of public events{% if club %} by {{club.name}}{% else %} on {{site.name}}, a free and open source live GPS tracking solution for orienteering events.{% endif %}" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:site_name" content="{{ site.name }}" />
<meta name="twitter:card" content="summary_large_image">{% if not club %}
<meta property="og:image" content="{% static '/img/og.jpg'%}?t=2022091500" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />{% endif %}
<style>
  .event-set-card:hover{box-shadow: rgb(0 0 0 / 15%) 0px 8px 16px 0px;}
</style>
{% endblock %}

{% block contentup %}
{% if club %}
  {% define club.nice_url as home_url %}
{% else %}
  {% url 'site:events_view' as home_url %}
{% endif %}
{% if club %}
<div class="container-fluid p-0">
  <div class="row m-0">
    <div class="w-100" style="background-color: #fff;">
      <div class="container content" style="min-height: 100px">
        <div class="row">
          {{club.description|markdownify }}
        </div>
      </div>
    </div>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1 1" width="100%" height="2em" preserveAspectRatio="none" fill="#f8f9fa" style="margin-top: -2em;" class="p-0"><path d="M0 1 L1 1 L0 0 Z"/></svg>
  </div>
</div>
<div class="container content">
{% else %}
<div class="container-fluid p-0">
<div class="row m-0">
  <div class="w-100 text-center" style="background-color: #000;">
    <picture>
      <source srcset="{% static 'img/banner.avif'%}" type="image/avif">
      <source srcset="{% static 'img/banner.webp'%}" type="image/webp">
      <img src="{% static 'img/banner.jpg'%}?v=20230113" alt="Banner" style="width: 100%; max-width: 1024px">
    </picture>
  </div>
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1 1" width="100%" height="2em" preserveAspectRatio="none" fill="#f8f9fa" style="margin-top: -2em;" class="p-0"><path d="M0 1 L1 1 L0 0 Z"/></svg>
</div>
</div>
<div class="container content">
{% endif %}
<div class="row">
  {%if event_set_page %}
  <div class="row mb-3">
    <h4 class="padded-multiline"><span>{{event_set.name}}</span></h4>
  </div>
  {% endif %}
  {% if live_events %}
  <div><h2>Live Events</h2></div>
  <div>
  {% for event_set in live_events %}
    {% if not event_set_page %}
    <div class="row">
      <h4 class="padded-multiline"><span>{% if not event_set.fake %}{{event_set.name}}{%else%}Event{% endif%}</span></h4>
      {% if not club %}<div class="mb-2" style="font-size: 0.8em; margin-left: 25px;max-width: calc(100% - 25px)">By <a class="link-primary" href="{{ event_set.events.0.club.get_absolute_url }}">{% if event_set.events.0.club.logo %}<img src="{{event_set.events.0.club.logo_url}}" width="25px" height="25px" alt="logo" style="vertical-align: bottom"/> {% endif %}{{ event_set.events.0.club.name }}</a></div>{% endif%}
    </div>
    {% endif %}
    {% for event in event_set.events %}
      <div class="card event-set-card mb-3">
        <div class="card-body">
          <div class="d-flex flex-row bd-highlight justify-content-between">
            <div class="px-2 py-1 bd-highlight">
              <div>
                <a class="link-primary stretched-link text-decoration-none" href="{{ event.get_absolute_url }}"><b style="font-size: 1.5em;">{{ event.name }}</b></a> <span class="ms-2 py-1 px-2 badge bg-danger fst-italic" style="font-size: 1em;"><b><i>LIVE</i></b></span>
              </div>
              <div style="color: grey; font-size:0.75em;line-height:0.8em">
                <span >{{ event.competitors.count}} participant{{ event.competitors.count|pluralize:"s" }}</span>
              </div>
            </div>
            <div class="p-2 bd-highlight justify-end">
              <div class="dropdown" style="z-index: {{ forloop.parentloop.revcounter|mult:100000|add:forloop.revcounter }};">
                <a class="btn btn-secondary" href="#" role="button" id="dropdownMenuLink-{{event.aid}}" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fa-solid fa-bars"></i>
                </a>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink-{{event.aid}}">
                  {% if event.allow_route_upload or event.open_registration and not event.ended  %}
                  <li><a href="{{event.club.nice_url}}{{event.slug}}/contribute" class="dropdown-item"><i class="fa-solid fa-circle-plus"></i> Competitor{% if event.open_registration and not event.ended %} registration{% endif %}{% if event.open_registration and event.allow_route_upload and event.started and not event.ended %} or{% endif %}{% if event.started and event.allow_route_upload %} route upload{% endif %}</a></li>
                  {% endif %}
                  <li><a href="{{event.club.nice_url}}{{event.slug}}/export" class="dropdown-item"><i class="fa-solid fa-floppy-disk"></i> Export</a></li>
                  {% if event.ended and event.map_id %}
                  <li><a href="http://3drerun.worldofo.com/2d/?server={{ site.domain }}/api/woo&eventid={{event.aid}}&liveid=-" target="_blank" rel="noopener noreferrer" class="dropdown-item"><i class="fa-solid fa-up-right-from-square" aria-hidden="true"></i> 2DRerun</a></li>
                  {% endif %}
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  {% endfor %}
  </div>
  <hr/>
  {% endif%}
  {% if upcoming_events %}
  <div>
    <h2>Upcoming Events</h2>
    <h6>Starting in next 24 hours</h6>
  </div>
  <div>
  {% for event_set in upcoming_events reversed %}
    {% if not event_set_page %}
    <div class="row">
      <h4 class="padded-multiline"><span>{% if not event_set.fake %}{{event_set.name}}{%else%}Event{% endif%}</span></h4>
      {% if not club %}<div class="mb-2" style="font-size: 0.8em; margin-left: 25px;max-width: calc(100% - 25px)">By <a class="link-primary" href="{{ event_set.events.0.club.get_absolute_url }}">{% if event_set.events.0.club.logo %}<img src="{{event_set.events.0.club.logo_url}}" width="25px" height="25px" alt="logo" style="vertical-align: bottom"/> {% endif %}{{ event_set.events.0.club.name }}</a></div>{% endif%}
    </div>
    {% endif%}
    {% for event in event_set.events reversed %}
      <div class="card event-set-card mb-3">
        <div class="card-body">
          <div class="d-flex flex-row bd-highlight justify-content-between">
            <div class="px-2 py-1 bd-highlight">
              <div>
                <a class="link-primary stretched-link text-decoration-none" href="{{ event.get_absolute_url }}"><b style="font-size: 1.5em;">{{ event.name }}</b></a>
              </div>
              <div>
                <span class="date-utc" data-date="{{ event.start_date|date:'c' }}">{{ event.start_date|date:'Y-m-d H:i' }}</span>
              </div>
              <div style="color: grey; font-size:0.75em;line-height:0.8em">
                <span >{{ event.competitors.count}} participant{{ event.competitors.count|pluralize:"s" }}</span>
              </div>
            </div>
            {% if event.open_registration and not event.ended  %}
            <div class="p-2 bd-highlight justify-end">
              <div class="dropdown" style="z-index: {{ forloop.parentloop.revcounter|mult:100000|add:forloop.revcounter }};">
                <a class="btn btn-secondary" href="#" role="button" id="dropdownMenuLink-{{event.aid}}" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fa-solid fa-bars"></i>
                </a>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink-{{event.aid}}">
                  <li><a href="{{event.club.nice_url}}{{event.slug}}/contribute" class="dropdown-item"><i class="fa-solid fa-circle-plus"></i> Competitor registration</a></li>
                </ul>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  {% endfor %}
  </div>
  {% if years or search_text or event_set_page and events %}
  <hr/>
  {% endif%}
  {% endif%}
  {% if years or search_text or event_set_page and events %}
  <div {% if not event_set_page %}class="mb-3"{% endif%}>
    <h2>Archived Events</h2>
      {% if home_url and not event_set_page %}
        <form class="mb-3 row" method="GET">
          <div class="col-auto">
            <input class="form-control" type="search" placeholder="Search" name="q" value="{{search_text}}">
          </div>
          <div class="col-auto">
            <input class="btn btn-primary" type="submit" value="Search">
          </div>
        </form>
        {% if search_text %}
        Results for search: "<i>{{search_text}}</i>"
        {% endif %}
        {% if years %}
        <div>{% if year %}<a href="{{home_url}}{% if search_text %}?q={{search_text|urlencode}}{% endif %}">All</a>{% else %}All{% endif%}{% for y in years %}&nbsp;{% if year == y %}{{ y }}{% else %}<a href="{{home_url}}?{% if search_text %}q={{search_text|urlencode}}&{% endif %}year={{ y }}">{{ y }}</a>{% endif %}{% endfor%}</div>
        {% if year %}
        <div>{% if month %}<a href="{{home_url}}?{% if search_text %}q={{search_text|urlencode}}&{% endif %}year={{year}}">All</a>{% else %}All{% endif%}{% for m in months %}&nbsp;{% if month == m %}{{ month_names|index:m }}{% else %}<a href="{{home_url}}?{% if search_text %}q={{search_text|urlencode}}&{% endif %}year={{ year }}&month={{m}}">{{ month_names|index:m }}</a>{% endif %}{% endfor%}</div>
        {% endif %}
        {% endif %}
      {% endif %}
  </div>
  {% endif %}
  <div>
  {% if events_page.paginator.num_pages > 1 %}{% bootstrap_pagination events_page extra=request.GET.urlencode %}{% endif %}
  {% for event_set in events %}
    {% if not event_set_page %}
    <div class="row">
      <h4 class="padded-multiline"><span>{% if not event_set.fake %}{{event_set.name}}{%else%}Event{% endif%}</span></h4>
      {% if not club %}<div class="mb-2" style="font-size: 0.8em; margin-left: 25px;max-width: calc(100% - 25px)">By <a class="link-primary" href="{{ event_set.events.0.club.get_absolute_url }}">{% if event_set.events.0.club.logo %}<img src="{{event_set.events.0.club.logo_url}}" width="25px" height="25px" alt="logo" style="vertical-align: bottom"/> {% endif %}{{ event_set.events.0.club.name }}</a></div>{% endif%}
    </div>
    {% endif %}
    {% for event in event_set.events %}
    <div class="card event-set-card mb-3">
      <div class="card-body">
        <div class="d-flex flex-row bd-highlight justify-content-between">
          <div class="px-2 py-1 bd-highlight">
            <div>
              <a class="link-primary stretched-link text-decoration-none" href="{{ event.get_absolute_url }}"><b style="font-size: 1.5em;">{{ event.name }}</b></a>
            </div>
            <div>
              <span class="date-utc" data-date="{{ event.start_date|date:'c' }}">{{ event.start_date|date:'Y-m-d H:i' }}</span>
            </div>
            <div style="color: grey; font-size:0.75em;line-height:0.8em">
              <span >{{ event.competitors.count}} participant{{ event.competitors.count|pluralize:"s" }}</span>
            </div>
          </div>
          <div class="p-2 bd-highlight justify-end">
            <div class="dropdown" style="z-index: {{ forloop.parentloop.revcounter|mult:100000|add:forloop.revcounter }};">
              <a class="btn btn-secondary" href="#" role="button" id="dropdownMenuLink-{{event.aid}}" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fa-solid fa-bars"></i>
              </a>
              <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink-{{event.aid}}">
                {% if event.started and event.allow_route_upload or event.open_registration and not event.ended  %}
                <li><a href="{{event.club.nice_url}}{{event.slug}}/contribute" class="dropdown-item"><i class="fa-solid fa-circle-plus"></i> Competitor{% if event.open_registration and not event.ended %} registration{% endif %}{% if event.open_registration and event.allow_route_upload and event.started and not event.ended %} or{% endif %}{% if event.started and event.allow_route_upload %} route upload{% endif %}</a></li>
                {% endif %}
                <li><a href="{{event.club.nice_url}}{{event.slug}}/export" class="dropdown-item"><i class="fa-solid fa-floppy-disk"></i> Export</a></li>
                {% if event.ended and event.map_id %}
                <li><a href="http://3drerun.worldofo.com/2d/?server={{ site.domain }}/api/woo&eventid={{event.aid}}&liveid=-" target="_blank" rel="noopener noreferrer" class="dropdown-item"><i class="fa-solid fa-up-right-from-square" aria-hidden="true"></i> 2DRerun</a></li>
                {% endif %}
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  {% endfor %}
  {% if events_page.paginator.num_pages > 1 %}{% bootstrap_pagination events_page extra=request.GET.urlencode %}{% endif %}
  </div>
  {% if not live_events and not events and not upcoming_events %}
    <div class="card">
      <div class="card-body">
        <h2 style="color: #888">No {% if not event_set_page or event_set.hide_secret_events %}public {% endif %}events...</h2>
      </div>
    </div>
  {% endif %}
</div>
</div>
{% endblock %}

{% block extra_body %}
{% compress js %}
<script src="{% static '/vendor/umbrella-3.3.1/umbrella.min.js' %}"></script>
<script src="{% static '/vendor/dayjs-1.11.7/dayjs.min.js' %}"></script>
<script src="{% static '/scripts/site/event_list.js' %}"></script>
{% endcompress %}
{% endblock %}

version: 2.1
jobs:
  build-and-test:
    # to speed up Dockers builds turn on layer caching
    # which is a paid CircleCI feature
    # https://circleci.com/docs/2.0/docker-layer-caching/
    machine:
      image: ubuntu-2004:202107-02
      docker_layer_caching: false
    steps:
    - checkout
    - run: ./gen-local-certs.sh
    - run: echo "127.0.0.1 routechoices.dev api.routechoices.dev www.routechoices.dev halden-sk.routechoices.dev" | sudo tee -a /etc/hosts
    - run: mkdir -p media/routechoices/maps/
    - run: ./dc up -d
    - run: ./dc pipinstall
    - run: ./da migrate
    - run: ./da collectstatic
    - run: ./da compress
    - run: ./dc restart nginx
    - run: ./dc restart django
    - run: timeout 300 bash -c 'while [[ "$(curl -s -o /dev/null -w ''%{http_code}'' https://www.routechoices.dev:8081)" != "200" ]]; do sleep 5; done' || false
    - run: ./da test --parallel
    - run: ./dc restart django
    - run: sudo apt update
    - run: sudo apt install -y libgbm-dev
    - run:
        name: Install Node.js 12 and run cypress
        # https://www.cloudesire.com/how-to-upgrade-node-on-circleci-machine-executor/
        command: |
          export NVM_DIR="/opt/circleci/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
          nvm install v16 && nvm use v16 && nvm alias default v16
          node -v
          curl -o- -L https://yarnpkg.com/install.sh | bash
          ~/.yarn/bin/yarn add cypress@6 cypress-file-upload cypress-real-events
          ~/.yarn/bin/yarn cypress install
          ~/.yarn/bin/yarn cypress run
    - store_artifacts:
        path: cypress/videos
    - store_artifacts:
        path: cypress/screenshots

  deploy:
    machine:
        image: ubuntu-2004:202107-02
        docker_layer_caching: false
    steps:
    - run:
        name: Deploy
        command: |
          ssh root@routechoices.com 'sudo -u apps /apps/routechoices-server/bin/deploy'

workflows:
  build_test_and_deploy:
    jobs:
      - build-and-test
      - deploy:
          requires:
            - build-and-test
          filters:
            branches:
              only:
                - master

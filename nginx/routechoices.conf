upstream webupstream {
  ip_hash;
  server django:8000;
}

upstream minio_upstream {
  ip_hash;
  server minio:9000;
}

server {
    location /static/ {
        autoindex on;
        alias /usr/share/nginx/html/;
    }

    location  ~ ^/s3/(.*) {
        internal;
        resolver                  127.0.0.11 ipv6=off;
        proxy_http_version        1.1;
        proxy_set_header          Connection "";
        proxy_set_header          Authorization '';
        proxy_hide_header         x-amz-id-2;
        proxy_hide_header         x-amz-request-id;
        proxy_hide_header         x-amz-meta-server-side-encryption;
        proxy_hide_header         x-amz-server-side-encryption;
        proxy_hide_header         Set-Cookie;
        proxy_ignore_headers      Set-Cookie;
        proxy_pass                http://minio_upstream/$1;
        proxy_intercept_errors    on;
    }

    location / {
        client_max_body_size 10M;
        proxy_pass http://webupstream/;
        proxy_set_header            X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header            X-Forwarded-Proto 'https';
        proxy_set_header Host       $http_host;
        proxy_connect_timeout       300;
        proxy_send_timeout          300;
        proxy_read_timeout          300;
        send_timeout                300;
    }
    server_name routechoices.dev *.routechoices.dev;

    gzip on;
    gzip_vary on;
    gzip_types      text/plain text/css text/xml text/javascript application/javascript application/xml application/json;
    gzip_proxied    no-cache no-store private expired auth;
    gzip_min_length 1000;
    gzip_comp_level 9;

    brotli on;
    brotli_comp_level 2;
    brotli_types text/plain text/css text/xml text/javascript application/javascript application/xml application/json;
    brotli_static on;


    listen [::]:443 ssl http2 reuseport; # managed by Certbot
    listen 443 ssl http2 reuseport; # managed by Certbot

    # include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
    ssl_certificate /usr/share/nginx/certs/routechoices.dev.crt; # managed by Certbot
    ssl_certificate_key /usr/share/nginx/certs/routechoices.dev.key; # managed by Certbot
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
}

server {
    location / {
        client_max_body_size 10k;
        proxy_pass http://django:8009;
        proxy_set_header            X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header            X-Forwarded-Proto 'https';
        proxy_set_header Host       $http_host;
        proxy_connect_timeout       300;
        proxy_send_timeout          300;
        proxy_read_timeout          300;
        send_timeout                300;
    }

    location /sse/ {
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        chunked_transfer_encoding off;
        proxy_pass http://django:8009;
    }

    server_name chat.routechoices.dev;

    listen [::]:443 ssl http2; # managed by Certbot
    listen 443 ssl http2; # managed by Certbot

    # include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
    ssl_certificate /usr/share/nginx/certs/routechoices.dev.crt; # managed by Certbot
    ssl_certificate_key /usr/share/nginx/certs/routechoices.dev.key; # managed by Certbot
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
}
server {
    location / {
        client_max_body_size 10k;
        proxy_pass http://django:8010;
        proxy_set_header            X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header            X-Forwarded-Proto 'https';
        proxy_set_header Host       $http_host;
        proxy_connect_timeout       300;
        proxy_send_timeout          300;
        proxy_read_timeout          300;
        send_timeout                300;
    }

    location /sse/ {
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        chunked_transfer_encoding off;
        proxy_pass http://django:8010;
    }

    server_name data.routechoices.dev;

    listen [::]:443 ssl http2; # managed by Certbot
    listen 443 ssl http2; # managed by Certbot

    # include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
    ssl_certificate /usr/share/nginx/certs/routechoices.dev.crt; # managed by Certbot
    ssl_certificate_key /usr/share/nginx/certs/routechoices.dev.key; # managed by Certbot
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
}
